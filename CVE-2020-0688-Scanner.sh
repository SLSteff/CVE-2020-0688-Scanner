#!/bin/bash
# Usage: ./CVE-2020-0688.sh -n <ip or iprange>
# masscan: https://github.com/robertdavidgraham/masscan
#
# License: MIT License
# Author: Bitschnau Stefan, https://github.com/SLSteff/CVE-2020-0688-Scanner
version="1.0"
CVE="CVE-2020-0688"
UserAgent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36"
randip()
{
    # random ip generator for usage/help display
    echo "$(((RANDOM%254)+1)).$(((RANDOM%254)+1)).$(((RANDOM%254)+1))"
}
usage()
{
    echo -e " This script scans given ips for port tcp/443 (https) and enumerates Microsoft Exchange versions. Versions older "
    echo -e " than February 11, 2020 will be considered vulnerable to $CVE. Exchange Servers hidden behind eg. netscaler"
    echo -e " can't be detected by this script. The version of Microsoft Exchange is gathered from the outlook web access page."
    echo -e ""
    echo -e " Version: $version"
    echo -e ""
    echo -e " CVE-2020-0688 | Microsoft Exchange Validation Key Remote Code Execution Vulnerability:"
    echo -e " https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-0688"
    echo -e ""
    echo -e " usage: $0 -n [ip/range/cidr]"
    echo -e "\t-h\tshow this help"
    echo -e "\t-n\tip/iprange/cidr to scan for exchange servers"
    echo -e "\t-v\tverbose mode (noisy output!)"
    echo -e ""
    echo -e " examples:"
    echo -e "\t$0 -n `randip`.0/24"
    echo -e "\t$0 -n `randip`.138"
    UsageIP=`randip`
    echo -e "\t$0 -n $UsageIP.194-$UsageIP.205"
    echo -e "\t$0 -n $UsageIP.83-$UsageIP.95,`randip`,`randip`.0/23"
}
script_verbose=0 # 0 = off / 1 = on
# get args
no_args=true
while getopts n:hv option; do
case "${option}" in
    n) IPRange=${OPTARG};;
    h) usage;exit 0;;
    v) script_verbose=1;;
    ?) usage; exit 1;;
    *) echo "Uknown option error!";usage;exit 1;;
    esac
    no_args=false
done
# if no args display usage
[[ "$no_args" == true ]] && { usage; exit 1; }
# no ips display usage
[[ "$IPRange" == "" ]] && { usage; exit 1; }

sverbose(){
    if [[ $script_verbose -eq "1" ]];
    then
        echo -e "\e[33mVERBOSE:\e[0m $@"
    fi
}
sverbose "Version: $version (verbose=$script_verbose)"
sverbose "Check if masscan is available"
# check if masscan is available:
if [ ! -x /usr/local/bin/masscan ] ; then
    sverbose "masscan binary not found"
    command -v masscan >/dev/null 2>&1 || { 
        echo >&2 "Please install masscan or set it in your path (https://github.com/robertdavidgraham/masscan) from Robert David Graham."
        sverbose "masscan not available, script end (error 1)"
        exit 1; 
    }
fi
sverbose "masscan available"
sverbose "range given: \"$IPRange\""
sverbose "declare microsoft exchange versions"
# declare microsoft exchange versions:
declare -A ExchangeVersions=(
    ["1527212"]="Exchange Server 2019 CU7 (15.2.721.2), September 15, 2020"
    ["1526594"]="Exchange Server 2019 CU6 (15.2.659.4), June 16, 2020"
    ["1525953"]="Exchange Server 2019 CU5 (15.2.595.3), March 17, 2020"
    ["1525295"]="Exchange Server 2019 CU4 (15.2.529.5), December 17, 2019"
    ["1524645"]="Exchange Server 2019 CU3 (15.2.464.5), September 17, 2019"
    ["1523973"]="Exchange Server 2019 CU2 (15.2.397.3), June 18, 2019"
    ["1523305"]="Exchange Server 2019 CU1 (15.2.330.5), February 12, 2019"
    ["15222112"]="Exchange Server 2019 RTM (15.2.221.12), October 22, 2018"
    ["1521960"]="Exchange Server 2019 Preview (15.2.196.0), July 24, 2018"
    ["15121062"]="Exchange Server 2016 CU18 (15.1.2106.2), September 15, 2020"
    ["15120444"]="Exchange Server 2016 CU17 (15.1.2044.4), June 16, 2020"
    ["15119793"]="Exchange Server 2016 CU16 (15.1.1979.3), March 17, 2020"
    ["15119135"]="Exchange Server 2016 CU15 (15.1.1913.5), December 17, 2019"
    ["15118473"]="Exchange Server 2016 CU14 (15.1.1847.3), September 17, 2019"
    ["15117792"]="Exchange Server 2016 CU13 (15.1.1779.2), June 18, 2019"
    ["15117135"]="Exchange Server 2016 CU12 (15.1.1713.5), February 12, 2019"
    ["151159110"]="Exchange Server 2016 CU11 (15.1.1591.10), October 16, 2018"
    ["15115313"]="Exchange Server 2016 CU10 (15.1.1531.3), June 19, 2018"
    ["15114663"]="Exchange Server 2016 CU9 (15.1.1466.3), March 20, 2018"
    ["15114152"]="Exchange Server 2016 CU8 (15.1.1415.2), December 19, 2017"
    ["151126135"]="Exchange Server 2016 CU7 (15.1.1261.35), September 19, 2017"
    ["151103426"]="Exchange Server 2016 CU6 (15.1.1034.26), June 27, 2017"
    ["15184534"]="Exchange Server 2016 CU5 (15.1.845.34), March 21, 2017"
    ["15166932"]="Exchange Server 2016 CU4 (15.1.669.32), December 13, 2016"
    ["15154427"]="Exchange Server 2016 CU3 (15.1.544.27), September 20, 2016"
    ["15146634"]="Exchange Server 2016 CU2 (15.1.466.34), June 21, 2016"
    ["15139630"]="Exchange Server 2016 CU1 (15.1.396.30), March 15, 2016"
    ["15122542"]="Exchange Server 2016 RTM (15.1.225.42), October 1, 2015"
    ["15122516"]="Exchange Server 2016 Preview (15.1.225.16), July 22, 2015"
    ["15014972"]="Exchange Server 2013 CU23 (15.0.1497.2), June 18, 2019"
    ["15014733"]="Exchange Server 2013 CU22 (15.0.1473.3), February 12, 2019"
    ["15013954"]="Exchange Server 2013 CU21 (15.0.1395.4), June 19, 2018"
    ["15013673"]="Exchange Server 2013 CU20 (15.0.1367.3), March 20, 2018"
    ["15013651"]="Exchange Server 2013 CU19 (15.0.1365.1), December 19, 2017"
    ["15013472"]="Exchange Server 2013 CU18 (15.0.1347.2), September 19, 2017"
    ["15013204"]="Exchange Server 2013 CU17 (15.0.1320.4), June 27, 2017"
    ["15012932"]="Exchange Server 2013 CU16 (15.0.1293.2), March 21, 2017"
    ["15012635"]="Exchange Server 2013 CU15 (15.0.1263.5), December 13, 2016"
    ["15012363"]="Exchange Server 2013 CU14 (15.0.1236.3), September 20, 2016"
    ["15012103"]="Exchange Server 2013 CU13 (15.0.1210.3), June 21, 2016"
    ["15011784"]="Exchange Server 2013 CU12 (15.0.1178.4), March 15, 2016"
    ["15011566"]="Exchange Server 2013 CU11 (15.0.1156.6), December 15, 2015"
    ["15011307"]="Exchange Server 2013 CU10 (15.0.1130.7), September 15, 2015"
    ["15011045"]="Exchange Server 2013 CU9 (15.0.1104.5), June 17, 2015"
    ["15010769"]="Exchange Server 2013 CU8 (15.0.1076.9), March 17, 2015"
    ["150104425"]="Exchange Server 2013 CU7 (15.0.1044.25), December 9, 2014"
    ["15099529"]="Exchange Server 2013 CU6 (15.0.995.29), August 26, 2014"
    ["15091322"]="Exchange Server 2013 CU5 (15.0.913.22), May 27, 2014"
    ["15084732"]="Exchange Server 2013 SP1 (15.0.847.32), February 25, 2014"
    ["15077538"]="Exchange Server 2013 CU3 (15.0.775.38), November 25, 2013"
    ["15071224"]="Exchange Server 2013 CU2 (15.0.712.24), July 9, 2013"
    ["15062029"]="Exchange Server 2013 CU1 (15.0.620.29), April 2, 2013"
    ["15051632"]="Exchange Server 2013 RTM (15.0.516.32), December 3, 2012"
    ["1434870"]="SBS 2011 Exchange Server 2010 SP3 probably CU29 (14.3.487.0)"
    ["1434960"]="Exchange Server 2010 SP3 CU30 (14.3.496.0), February 11, 2020"
    ["1434680"]="Exchange Server 2010 SP3 CU29 (14.3.468.0), July 9, 2019"
    ["1434611"]="Exchange Server 2010 SP3 CU28 (14.3.461.1), June 7, 2019"
    ["1434520"]="Exchange Server 2010 SP3 CU27 (14.3.452.0), April 9, 2019"
    ["1434420"]="Exchange Server 2010 SP3 CU26 (14.3.442.0), February 12, 2019"
    ["1434390"]="SBS 2011 Exchange Server 2010 SP3 probably CU25 (14.3.439.0)"
    ["1434350"]="Exchange Server 2010 SP3 CU25 (14.3.435.0), January 8, 2019"
    ["1434190"]="Exchange Server 2010 SP3 CU24 (14.3.419.0), September 5, 2018"
    ["1434171"]="Exchange Server 2010 SP3 CU23 (14.3.417.1), August 13, 2018"
    ["1434110"]="Exchange Server 2010 SP3 CU22 (14.3.411.0), June 19, 2018"
    ["1433992"]="Exchange Server 2010 SP3 CU21 (14.3.399.2), May 7, 2018"
    ["1433891"]="Exchange Server 2010 SP3 CU20 (14.3.389.1), March 5, 2018"
    ["1433820"]="Exchange Server 2010 SP3 CU19 (14.3.382.0), December 19, 2017"
    ["1433611"]="Exchange Server 2010 SP3 CU18 (14.3.361.1), July 11, 2017"
    ["1433520"]="Exchange Server 2010 SP3 CU17 (14.3.352.0), March 21, 2017"
    ["1433360"]="Exchange Server 2010 SP3 CU16 (14.3.336.0), December 13, 2016"
    ["1433192"]="Exchange Server 2010 SP3 CU15 (14.3.319.2), September 20, 2016"
    ["1433010"]="Exchange Server 2010 SP3 CU14 (14.3.301.0), June 21, 2016"
    ["1432940"]="Exchange Server 2010 SP3 CU13 (14.3.294.0), March 15, 2016"
    ["1432792"]="Exchange Server 2010 SP3 CU12 (14.3.279.2), December 15, 2015"
    ["1432662"]="Exchange Server 2010 SP3 CU11 (14.3.266.2), September 15, 2015"
    ["1432482"]="Exchange Server 2010 SP3 CU10 (14.3.248.2), June 17, 2015"
    ["1432351"]="Exchange Server 2010 SP3 CU9 (14.3.235.1), March 17, 2015"
    ["1432242"]="Exchange Server 2010 SP3 CU8 v2 (14.3.224.2), December 12, 2014"
    ["1432241"]="Exchange Server 2010 SP3 CU8 v1 (recalled) (14.3.224.1), December 9, 2014"
    ["1432102"]="Exchange Server 2010 SP3 CU7 (14.3.210.2), August 26, 2014"
    ["1431951"]="Exchange Server 2010 SP3 CU6 (14.3.195.1), May 27, 2014"
    ["1431816"]="Exchange Server 2010 SP3 CU5 (14.3.181.6), February 24, 2014"
    ["1431741"]="Exchange Server 2010 SP3 CU4 (14.3.174.1), December 9, 2013"
    ["1431691"]="Exchange Server 2010 SP3 CU3 (14.3.169.1), November 25, 2013"
    ["1431581"]="Exchange Server 2010 SP3 CU2 (14.3.158.1), August 8, 2013"
    ["1431460"]="Exchange Server 2010 SP3 CU1 (14.3.146.0), May 29, 2013"
    ["1431233"]="SBS 2011 Exchange Server 2010 SP3 probably without CU (14.3.123.3)"
    ["1431234"]="Exchange Server 2010 SP3 (14.3.123.4), February 12, 2013"
    ["1423901"]="SBS 2011 Exchange Server 2010 SP2 probably CU8 (14.2.390.1)"
    ["1423903"]="Exchange Server 2010 SP2 CU8 (14.2.390.3), December 9, 2013"
    ["1423750"]="Exchange Server 2010 SP2 CU7 (14.2.375.0), August 3, 2013"
    ["1423423"]="Exchange Server 2010 SP2 CU6 (14.2.342.3), February 12, 2013"
    ["14232810"]="Exchange Server 2010 SP2 CU5 v2 (14.2.328.10), December 10, 2012"
    ["1433285"]="Exchange Server 2010 SP2 CU5 (14.3.328.5), November 13, 2012"
    ["1423184"]="Exchange Server 2010 SP2 CU4 v2 (14.2.318.4), October 9, 2012"
    ["1423182"]="Exchange Server 2010 SP2 CU4 (14.2.318.2), August 13, 2012"
    ["1423092"]="Exchange Server 2010 SP2 CU3 (14.2.309.2), May 29, 2012"
    ["1422984"]="Exchange Server 2010 SP2 CU2 (14.2.298.4), April 16, 2012"
    ["1422833"]="Exchange Server 2010 SP2 CU1 (14.2.283.3), February 13, 2012"
    ["1422475"]="Exchange Server 2010 SP2 (14.2.247.5), December 4, 2011"
    ["1414380"]="Exchange Server 2010 SP1 CU8 (14.1.438.0), December 10, 2012"
    ["1414213"]="Exchange Server 2010 SP1 CU7 v3 (14.1.421.3), November 13, 2012"
    ["1414212"]="Exchange Server 2010 SP1 CU7 v2 (14.1.421.2), October 10, 2012"
    ["1414210"]="Exchange Server 2010 SP1 CU7 (14.1.421.0), August 8, 2012"
    ["1413552"]="Exchange Server 2010 SP1 CU6 (14.1.355.2), October 27, 2011"
    ["1413391"]="Exchange Server 2010 SP1 CU5 (14.1.339.1), August 23, 2011"
    ["1413236"]="Exchange Server 2010 SP1 CU4 (14.1.323.6), July 27, 2011"
    ["1412897"]="Exchange Server 2010 SP1 CU3 (14.1.289.7), April 6, 2011"
    ["1412701"]="Exchange Server 2010 SP1 CU2 (14.1.270.1), December 9, 2010"
    ["1412552"]="Exchange Server 2010 SP1 CU1 (14.1.255.2), October 4, 2010"
    ["14121813"]="SBS 2011 Exchange Server 2010 SP2 probably CU (14.1.218.13)"
    ["14121815"]="Exchange Server 2010 SP1 (14.1.218.15), August 23, 2010"
    ["1407260"]="Exchange Server 2010 CU5 (14.0.726.0), December 13, 2010"
    ["1407021"]="Exchange Server 2010 CU4 (14.0.702.1), June 10, 2010"
    ["1406940"]="Exchange Server 2010 CU3 (14.0.694.0), April 13, 2010"
    ["1406890"]="Exchange Server 2010 CU2 (14.0.689.0), March 4, 2010"
    ["1406821"]="Exchange Server 2010 CU1 (14.0.682.1), December 9, 2009"
    ["14063921"]="Exchange Server 2010 RTM (14.0.639.21), November 9, 2009"
    ["835170"]="Exchange Server 2007 SP3 CU23 (8.3.517.0), March 21, 2017"
    ["835020"]="Exchange Server 2007 SP3 CU22 (8.3.502.0), December 13, 2016"
    ["834851"]="Exchange Server 2007 SP3 CU21 (8.3.485.1), September 20, 2016"
    ["834680"]="Exchange Server 2007 SP3 CU20 (8.3.468.0), June 21, 2016"
    ["834590"]="forExchange Server 2007 SP3 CU19 (8.3.459.0), March 15, 2016"
    ["834450"]="forExchange Server 2007 SP3 CU18 (8.3.445.0), December, 2015"
    ["834171"]="forExchange Server 2007 SP3 CU17 (8.3.417.1), June 17, 2015"
    ["834060"]="Exchange Server 2007 SP3 CU16 (8.3.406.0), March 17, 2015"
    ["833892"]="Exchange Server 2007 SP3 CU15 (8.3.389.2), December 9, 2014"
    ["833792"]="Exchange Server 2007 SP3 CU14 (8.3.379.2), August 26, 2014"
    ["833482"]="Exchange Server 2007 SP3 CU13 (8.3.348.2), February 24, 2014"
    ["833424"]="Exchange Server 2007 SP3 CU12 (8.3.342.4), December 9, 2013"
    ["833271"]="Exchange Server 2007 SP3 CU11 (8.3.327.1), August 13, 2013"
    ["832983"]="Exchange Server 2007 SP3 CU10 (8.3.298.3), February 11, 2013"
    ["832972"]="Exchange Server 2007 SP3 CU9 (8.3.297.2), December 10, 2012"
    ["832796"]="Exchange Server 2007 SP3 CU8-v3 (8.3.279.6), November 13, 2012"
    ["832795"]="Exchange Server 2007 SP3 CU8-v2 (8.3.279.5), October 9, 2012"
    ["832793"]="Exchange Server 2007 SP3 CU8 (8.3.279.3), August 13, 2012"
    ["832640"]="Exchange Server 2007 SP3 CU7 (8.3.264.0), April 16, 2012"
    ["832452"]="Exchange Server 2007 SP3 CU6 (8.3.245.2), January 26, 2012"
    ["832131"]="Exchange Server 2007 SP3 CU5 (8.3.213.1), September 21, 2011"
    ["831921"]="Exchange Server 2007 SP3 CU4 (8.3.192.1), May 28, 2011"
    ["831592"]="Exchange Server 2007 SP3 CU3-v2 (8.3.159.2), March 30, 2011"
    ["831373"]="Exchange Server 2007 SP3 CU2 (8.3.137.3), December 10, 2010"
    ["831062"]="Exchange Server 2007 SP3 CU1 (8.3.106.2), September 9, 2010"
    ["83836"]="Exchange Server 2007 SP3 (8.3.83.6), June 7, 2010"
    ["823053"]="Exchange Server 2007 SP2 CU5 (8.2.305.3), December 7, 2010"
    ["822540"]="Exchange Server 2007 SP2 CU4 (8.2.254.0), April 9, 2010"
    ["822472"]="Exchange Server 2007 SP2 CU3 (8.2.247.2), March 17, 2010"
    ["822341"]="Exchange Server 2007 SP2 CU2 (8.2.234.1), January 22, 2010"
    ["822173"]="Exchange Server 2007 SP2 CU1 (8.2.217.3), November 19, 2009"
    ["821762"]="Exchange Server 2007 SP2 (8.2.176.2), August 24, 2009"
    ["814360"]="Exchange Server 2007 SP1 CU10 (8.1.436.0), April 13, 2010"
    ["813931"]="Exchange Server 2007 SP1 CU9 (8.1.393.1), July 16, 2009"
    ["813752"]="Exchange Server 2007 SP1 CU8 (8.1.375.2), May 19, 2009"
    ["813592"]="Exchange Server 2007 SP1 CU7 (8.1.359.2), March 18, 2009"
    ["813401"]="Exchange Server 2007 SP1 CU6 (8.1.340.1), February 10, 2009"
    ["813361"]="Exchange Server 2007 SP1 CU5 (8.1.336.1), November 20, 2008"
    ["813113"]="Exchange Server 2007 SP1 CU4 (8.1.311.3), October 7, 2008"
    ["812912"]="Exchange Server 2007 SP1 CU3 (8.1.291.2), July 8, 2008"
    ["812782"]="Exchange Server 2007 SP1 CU2 (8.1.278.2), May 9, 2008"
    ["812631"]="Exchange Server 2007 SP1 CU1 (8.1.263.1), February 28, 2008"
    ["812406"]="Exchange Server 2007 SP1 (8.1.240.6), November 29, 2007"
    ["808130"]="Exchange Server 2007 CU7 (8.0.813.0), July 8, 2008"
    ["807832"]="Exchange Server 2007 CU6 (8.0.783.2), February 21, 2008"
    ["807540"]="Exchange Server 2007 CU5 (8.0.754.0), October 25, 2007"
    ["807440"]="Exchange Server 2007 CU4 (8.0.744.0), August 23, 2007"
    ["807301"]="Exchange Server 2007 CU3 (8.0.730.1), June 28, 2007"
    ["807112"]="Exchange Server 2007 CU2 (8.0.711.2), May 8, 2007"
    ["807083"]="Exchange Server 2007 CU1 (8.0.708.3), April 17, 2007"
    ["8068525"]="Exchange Server 2007 RTM (8.0.685.25), March 8, 2007"
    ["6576544"]="Exchange Server 2003 post-SP2 (6.5.7654.4), August 2008"
    ["65765333"]="Exchange Server 2003 post-SP2 (6.5.7653.33), March 2008"
    ["657683"]="Exchange Server 2003 SP2 (6.5.7683), October 19, 2005"
    ["657226"]="Exchange Server 2003 SP1 (6.5.7226), May25, 2004"
    ["656944"]="Exchange Server 2003 (6.5.6944), September 28, 2003"
)

sverbose "starting massscan \"masscan -p443 --rate 10000 $IPRange\"..."
MSScanResult=`masscan -p443 --rate 10000 $IPRange | cut -d" " -f 6`
HostsFound=`echo $MSScanResult | wc -w`
sverbose "masscan done, $HostsFound host(s) found with port tcp/443 open"
vulnerable=0
exchfound=0
sverbose "useragent for curl: \"$UserAgent\""
sverbose "looping through masscan results"
for ip in $MSScanResult
do
    ExchangeMSG=$null
#    echo "DEBUG IP: $ip"
    sverbose "scanning ip $ip"
    sverbose "\tget content from \"https://$ip/owa/auth/logon.aspx\" with curl"
    content=$(curl -A $UserAgent https://$ip/owa/auth/logon.aspx -s -k | grep "owa" | grep "themes/resources/favicon.ico" | rev |cut -d"/" -f 5 | rev)
    sverbose "\tgot content \"$content\""
    ExchangeFull=`echo $content | tr -d .`
    if [ -n "$ExchangeFull" ] && [ "$ExchangeFull" -eq "$ExchangeFull" ] 2>/dev/null; then
        sverbose "\tgot versionnubmer for comparison: $ExchangeFull"
    else
        sverbose "\tthis is not an exchange server, skip this ip \"$ip\" [result: \"$content\" / got as version: \"$ExchangeFull\"]"
        continue
    fi
    ExchangeHV=`echo $content | cut -d"." -f1-2 | tr -d .`
    ExchangeSV=`echo $content | cut -d"." -f3`
    sverbose "\tmain version \"$ExchangeHV\" / subversion \"$ExchangeSV\""
    sverbose "\tget certificate-subject from \"https://$ip/owa\" with curl"
    certreq=$(curl -A $UserAgent --insecure -vvI https://$ip/owa 2>&1 | awk 'BEGIN { cert=0 } /^\* SSL connection/ { cert=1 } /^\*/ { if (cert) print }' | grep subject | rev | cut -d"=" -f1 | rev)
    if [ -z "$certreq" ]
    then
        certreq="unbekannt"
        sverbose "\tgot no certificate-subject, certreq empty"
    else
        sverbose "\tgot certificate-subject: \"$certreq\""
    fi
    if [ -n "$ExchangeHV" ]
    then
        sverbose "\treverse lookup ip $ip"
        #reverse=`dig -x $ip +short` # dig option
        reverse=`host $ip | cut -d " " -f5` # host option
        if [ -n "$reverse" ];
        then
            if [ $reverse == "3(NXDOMAIN)" ];
            then
                sverbose "\tno ptr found"
                ptr="<not set>"
            else
                ptr=$reverse
                sverbose "\tptr: $ip = $ptr"
            fi
        else
            sverbose "\tno ptr found"
            ptr="<not set>"
        fi
        sverbose "\tsearching for exchange version MSG in table."
        for key in "${!ExchangeVersions[@]}";
        do
            if [ "$key" -eq "$ExchangeFull" ] || [ "${key::-1}" -eq "$ExchangeFull" ] || [ "${key::-2}" -eq "$ExchangeFull" ];
            then
                ExchangeMSG="${ExchangeVersions[$key]}"
                sverbose "\tfound a MSG to display: \"$ExchangeMSG\""
                ((exchfound++))
            fi
        done
        if [ -z "$ExchangeMSG" ];
        then
            sverbose "\tcound'nt find exchange version, maybe a small business server? Try searching manually online with the following versionnumber: \"$content\"."
            ExchangeMSG="Couldn't detect version: \"$ExchangeFull\" ($content) (Small Business Server?), maybe";
        fi
        if [ "$ExchangeHV" -eq "152" ]
        then
            # Exchange 2019
            if [ "$ExchangeSV" -le "397" ]
            then
                sverbose "\tThis version is vulnerable"
                echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
                ((vulnerable++))
            else
                sverbose "\tnot vulnerable"
                echo -e "$ip: \e[32m$ExchangeMSG not vulnerable. [PTR:$ptr/CERT:$certreq]\e[0m"
            fi
        elif  [ "$ExchangeHV" -eq "151" ]
        then
            # Exchange 2016
            if [ "$ExchangeSV" -le "1780" ]
            then
                sverbose "\tThis version is vulnerable"
                echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
                ((vulnerable++))
            else
                sverbose "\tnot vulnerable"
                echo -e "$ip: \e[32m$ExchangeMSG not vulnerable. [PTR:$ptr/CERT:$certreq]\e[0m"
            fi
 
        elif [ "$ExchangeHV" -eq "150" ]
        then
            # Exchange 2013
            if [ "$ExchangeSV" -le "1473" ]
            then
                sverbose "\tThis version is vulnerable"
                echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
                ((vulnerable++))
            else
                sverbose "\tnot vulnerable"                
                echo -e "$ip: \e[32m$ExchangeMSG not vulnerable. [PTR:$ptr/CERT:$certreq]\e[0m"
            fi
        elif [ "$ExchangeHV$ExchangeSV" -eq "143487" ]
        then
            # SBS 2011 / Exchange 2010 SP3
            # Source: https://blog.rapid7.com/2020/04/06/phishing-for-system-on-microsoft-exchange-cve-2020-0688/ ("Remy S" in comments section)
            # 
            # Check if the file exists, the version number is in the path.
            sverbose "\tExchange SP3 CU30 does not update the version in owa html source, verify existence of file \"https://$ip/ecp/14.3.496.0/Scripts/microsoftajax.js\""
            # --head is not supported by all servers... so we need to HTTP GET the site :(
            if curl --fail -A $UserAgent -s -k https://$ip/ecp/14.3.496.0/Scripts/microsoftajax.js >/dev/null 2>&1;
            then
                sverbose "\tnot vulnerable, found \"https://$ip/ecp/14.3.496.0/Scripts/microsoftajax.js\""
                sverbose "\tgot wrong version from owa, overwriting Exchange MSG with \"SBS 2011 Exchange Server 2010 SP3 probably CU29 (14.3.487.0)\""
                ExchangeMSG="SBS 2011 Exchange Server 2010 SP3 probably CU30 (14.3.396.0)"
                echo -e "$ip: \e[32m$ExchangeMSG not vulnerable. [PTR:$ptr/CERT:$certreq]\e[0m"
            else
                sverbose "\tnot found, this version is vulnerable"
                echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
                ((vulnerable++))
            fi
        elif [ "$ExchangeHV" -eq "143" ]
        then
            # Exchange 2010 SP3
            if [ "$ExchangeSV" -le "496" ]
            then
                sverbose "\tThis version is vulnerable"
                echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
                ((vulnerable++))
            else
                sverbose "\tnot vulnerable"
                echo -e "$ip: \e[32m$ExchangeMSG not vulnerable. [PTR:$ptr/CERT:$certreq]\e[0m"
            fi

        elif [ "$ExchangeHV" -eq "142" ]
        then
            # Exchange 2010 SP2
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
            ((vulnerable++))
        elif [ "$ExchangeHV" -eq "141" ]
        then
            # Exchange 2010 SP1
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
            ((vulnerable++))
        elif [ "$ExchangeHV" -eq "140" ]
        then
            # Exchange 2010 ohne SP
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m"
            ((vulnerable++))
        elif [ "$ExchangeHV" -eq "83" ]
        then
            # Exchange 2007 SP3
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m \e[45m(EXCHANGE ZU ALT!)\e[0m"
            ((vulnerable++))
        elif [ "$ExchangeHV" -eq "82" ]
        then
            # Exchange 2007 SP2
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m \e[45m(EXCHANGE ZU ALT!)\e[0m"
            ((vulnerable++))
        elif [ "$ExchangeHV" -eq "81" ]
        then
            # Exchange 2007 SP1
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m \e[45m(EXCHANGE ZU ALT!)\e[0m"
            ((vulnerable++))
        elif [ "$ExchangeHV" -eq "80" ]
        then
            # Exchange 2007 ohne SP
            sverbose "\tThis version is vulnerable"
            echo -e "$ip: \e[41m$ExchangeMSG VULNERABLE $CVE! [PTR:$ptr/CERT:$certreq]\e[0m \e[45m(EXCHANGE ZU ALT!)\e[0m"
            ((vulnerable++))
        else
            sverbose "\tcould'nt detect exchange version, check manually!"
            echo -e "$ip: \e[32mUnkown Exchange Version (Expression: $content) [PTR:$ptr/CERT:$certreq]\e[0m"
        fi
    else
        sverbose "\tno main version! skip this ip"
    fi
    content=""    
done

if [ $exchfound -eq 0 ]; then
    echo -e "\nNo Microsoft Exchange Server(s) found. ($HostsFound host(s) with open tcp/443 found)"
else
    if [ $vulnerable -eq 0 ]; then
        echo -e "\n$exchfound Microsoft Exchange Server(s) found, none of which are vulnerable. ($HostsFound host(s) with open tcp/443 found)"
    else
        echo -e "\n$exchfound Microsoft Exchange Server(s) found, $vulnerable are vulnerable. ($HostsFound host(s) with open tcp/443 found)"
    fi
fi

